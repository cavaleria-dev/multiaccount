# –ü–ª–∞–Ω: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Ñ—Ä–∞–Ω—à–∏–∑—ã

**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** 2025-10-14
**–°—Ç–∞—Ç—É—Å:** –í —Ä–∞–±–æ—Ç–µ
**–¶–µ–ª—å:** –î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤, –º–∞–ø–ø–∏–Ω–≥ —Ü–µ–Ω, –≤—ã–±–æ—Ä –¥–æ–ø.–ø–æ–ª–µ–π –∏ –∫–Ω–æ–ø–∫—É "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É"

---

## –û–±—â–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ß—Ç–æ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É–µ–º:
- ‚úÖ –¢–æ–≤–∞—Ä—ã (product) + **—É–ø–∞–∫–æ–≤–∫–∏** + **—à—Ç—Ä–∏—Ö–∫–æ–¥—ã**
- ‚úÖ –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏ (variant)
- ‚úÖ –ö–æ–º–ø–ª–µ–∫—Ç—ã (bundle)
- ‚ùå **–£—Å–ª—É–≥–∏ (service)** - –¥–æ–±–∞–≤–∏—Ç—å
- ‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è (—É–∂–µ –µ—Å—Ç—å)
- ‚úÖ –¶–µ–Ω—ã (–¥–æ–±–∞–≤–∏—Ç—å –º–∞–ø–ø–∏–Ω–≥)
- ‚úÖ –î–æ–ø.–ø–æ–ª—è (–¥–æ–±–∞–≤–∏—Ç—å –≤—ã–±–æ—Ä)

**–í–∞–∂–Ω–æ:** –£–ø–∞–∫–æ–≤–∫–∏ (packs) –∏ —à—Ç—Ä–∏—Ö–∫–æ–¥—ã (barcodes) —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤–º–µ—Å—Ç–µ —Å —Ç–æ–≤–∞—Ä–∞–º–∏, –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫.

### –ü–æ–ª–µ —Å–æ–ø–æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤:
–í—ã–±–æ—Ä –∏–∑: `code`, `article`, `externalCode`, `barcode`
–ü–æ —ç—Ç–æ–º—É –ø–æ–ª—é –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ —Ç–æ–≤–∞—Ä –≤–æ —Ñ—Ä–∞–Ω—à–∏–∑–µ.

### –°–æ–∑–¥–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ –≤–æ —Ñ—Ä–∞–Ω—à–∏–∑–µ:

**–î–æ–ø.–ø–æ–ª—è (attributes):**
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ **–Ω–∞–∑–≤–∞–Ω–∏—é –ò —Ç–∏–ø—É**
- –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, —Å–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–µ, —Å–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥

**–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ (characteristics):**
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ **–Ω–∞–∑–≤–∞–Ω–∏—é** (—Ç–∏–ø–∞ —É —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –Ω–µ—Ç)
- –ï—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç ‚Üí –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å, —Å–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥
- –ï—Å–ª–∏ –Ω–µ—Ç ‚Üí —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é, —Å–æ–∑–¥–∞—Ç—å –º–∞–ø–ø–∏–Ω–≥

**–°–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∏ (customentity):**
- ‚úÖ –£–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ –≤ `CustomEntitySyncService`
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é
- –≠–ª–µ–º–µ–Ω—Ç—ã —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–∞ —Ç–æ–∂–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é

**–¢–∏–ø—ã —Ü–µ–Ω (price types):**
- –ú–∞–ø–ø–∏–Ω–≥ —á–µ—Ä–µ–∑ UI: main_price_id ‚Üí child_price_id
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã

**–ì—Ä—É–ø–ø—ã —Ç–æ–≤–∞—Ä–æ–≤ (productFolder):**
- –§–ª–∞–≥ `create_product_folders` (boolean)
- –ï—Å–ª–∏ true ‚Üí —Å–æ–∑–¥–∞–≤–∞—Ç—å –≥—Ä—É–ø–ø—ã –≤–æ —Ñ—Ä–∞–Ω—à–∏–∑–µ
- –ï—Å–ª–∏ false ‚Üí –Ω–µ —Å–æ–∑–¥–∞–≤–∞—Ç—å, —Ç–æ–≤–∞—Ä—ã –≤ –∫–æ—Ä–Ω–µ

---

## –§–∞–∑–∞ 1: Backend - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –º–æ–¥–µ–ª–∏ (30 –º–∏–Ω) ‚è≥

**–§–∞–π–ª:** `database/migrations/YYYY_MM_DD_HHMMSS_add_advanced_sync_settings.php`

### –ù–æ–≤—ã–µ –∫–æ–ª–æ–Ω–∫–∏ –≤ `sync_settings`:

```php
Schema::table('sync_settings', function (Blueprint $table) {
    $table->boolean('sync_services')->default(false)->after('sync_bundles');
    $table->boolean('sync_images')->default(true)->after('sync_services');
    $table->boolean('create_product_folders')->default(true)->after('sync_product_folders');
    $table->json('price_mappings')->nullable()->after('price_types');
    $table->json('attribute_sync_list')->nullable()->after('catalog_filters');
});
```

### –û–±–Ω–æ–≤–∏—Ç—å –º–æ–¥–µ–ª—å `app/Models/SyncSetting.php`:

```php
protected $fillable = [
    // ... existing
    'sync_services',
    'sync_images',
    'create_product_folders',
    'price_mappings',
    'attribute_sync_list',
];

protected $casts = [
    // ... existing
    'sync_services' => 'boolean',
    'sync_images' => 'boolean',
    'create_product_folders' => 'boolean',
    'price_mappings' => 'array',
    'attribute_sync_list' => 'array',
];
```

**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ –Ω–∞—á–∞—Ç–æ

---

## –§–∞–∑–∞ 2: Backend - API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã (1 —á–∞—Å) ‚è≥

### 2.1. –†–∞—Å—à–∏—Ä–∏—Ç—å `app/Http/Controllers/Api/SyncSettingsController.php`

#### –ú–µ—Ç–æ–¥ `getPriceTypes(Request $request, $accountId)`
```php
/**
 * GET /api/sync-settings/{accountId}/price-types
 *
 * –ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø—ã —Ü–µ–Ω –∏–∑ main –∏ child –∞–∫–∫–∞—É–Ω—Ç–æ–≤
 */
public function getPriceTypes(Request $request, $accountId)
{
    $contextData = $request->get('moysklad_context');
    $mainAccountId = $contextData['accountId'];

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —ç—Ç–æ –¥–æ—á–µ—Ä–Ω–∏–π –∞–∫–∫–∞—É–Ω—Ç
    $link = DB::table('child_accounts')
        ->where('parent_account_id', $mainAccountId)
        ->where('child_account_id', $accountId)
        ->first();

    if (!$link) {
        return response()->json(['error' => 'Child account not found'], 404);
    }

    // –ü–æ–ª—É—á–∏—Ç—å —Ç–∏–ø—ã —Ü–µ–Ω –∏–∑ –æ–±–æ–∏—Ö –∞–∫–∫–∞—É–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ –ú–æ–π–°–∫–ª–∞–¥ API
    $mainAccount = Account::where('account_id', $mainAccountId)->first();
    $childAccount = Account::where('account_id', $accountId)->first();

    $moysklad = app(MoySkladService::class);

    $mainPriceTypes = $moysklad->request($mainAccount->access_token, 'GET', '/entity/pricetype');
    $childPriceTypes = $moysklad->request($childAccount->access_token, 'GET', '/entity/pricetype');

    return response()->json([
        'main' => array_map(fn($pt) => [
            'id' => $pt['id'],
            'name' => $pt['name']
        ], $mainPriceTypes['rows'] ?? []),
        'child' => array_map(fn($pt) => [
            'id' => $pt['id'],
            'name' => $pt['name']
        ], $childPriceTypes['rows'] ?? [])
    ]);
}
```

#### –ú–µ—Ç–æ–¥ `getAttributes(Request $request, $accountId)`
```php
/**
 * GET /api/sync-settings/{accountId}/attributes
 *
 * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –¥–æ–ø.–ø–æ–ª—è –∏–∑ main –∞–∫–∫–∞—É–Ω—Ç–∞
 */
public function getAttributes(Request $request, $accountId)
{
    $contextData = $request->get('moysklad_context');
    $mainAccountId = $contextData['accountId'];

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å
    $link = DB::table('child_accounts')
        ->where('parent_account_id', $mainAccountId)
        ->where('child_account_id', $accountId)
        ->first();

    if (!$link) {
        return response()->json(['error' => 'Child account not found'], 404);
    }

    // –ü–æ–ª—É—á–∏—Ç—å –¥–æ–ø.–ø–æ–ª—è product –∏–∑ main –∞–∫–∫–∞—É–Ω—Ç–∞
    $mainAccount = Account::where('account_id', $mainAccountId)->first();
    $moysklad = app(MoySkladService::class);

    $attributes = $moysklad->request($mainAccount->access_token, 'GET', '/entity/product/metadata');

    $result = [];
    foreach ($attributes['attributes'] ?? [] as $attr) {
        $result[] = [
            'id' => $attr['id'],
            'name' => $attr['name'],
            'type' => $attr['type']
        ];
    }

    return response()->json(['data' => $result]);
}
```

#### –ú–µ—Ç–æ–¥ `getFolders(Request $request, $accountId)`
```php
/**
 * GET /api/sync-settings/{accountId}/folders
 *
 * –ü–æ–ª—É—á–∏—Ç—å –¥–µ—Ä–µ–≤–æ –≥—Ä—É–ø–ø —Ç–æ–≤–∞—Ä–æ–≤ –∏–∑ main –∞–∫–∫–∞—É–Ω—Ç–∞
 */
public function getFolders(Request $request, $accountId)
{
    $contextData = $request->get('moysklad_context');
    $mainAccountId = $contextData['accountId'];

    // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å
    $link = DB::table('child_accounts')
        ->where('parent_account_id', $mainAccountId)
        ->where('child_account_id', $accountId)
        ->first();

    if (!$link) {
        return response()->json(['error' => 'Child account not found'], 404);
    }

    // –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –ø–∞–ø–∫–∏
    $mainAccount = Account::where('account_id', $mainAccountId)->first();
    $moysklad = app(MoySkladService::class);

    $folders = $moysklad->request($mainAccount->access_token, 'GET', '/entity/productfolder', [
        'limit' => 1000
    ]);

    // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ä–µ–≤–æ
    $folderTree = $this->buildFolderTree($folders['rows'] ?? []);

    return response()->json(['data' => $folderTree]);
}

/**
 * –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ä–µ–≤–æ –ø–∞–ø–æ–∫ –∏–∑ –ø–ª–æ—Å–∫–æ–≥–æ —Å–ø–∏—Å–∫–∞
 */
private function buildFolderTree(array $folders): array
{
    $tree = [];
    $indexed = [];

    // –ò–Ω–¥–µ–∫—Å–∏—Ä–æ–≤–∞—Ç—å –ø–∞–ø–∫–∏
    foreach ($folders as $folder) {
        $indexed[$folder['id']] = [
            'id' => $folder['id'],
            'name' => $folder['name'],
            'pathName' => $folder['pathName'] ?? $folder['name'],
            'parent_id' => $folder['productFolder']['meta']['href'] ?? null,
            'children' => []
        ];

        if ($indexed[$folder['id']]['parent_id']) {
            $parts = explode('/', $indexed[$folder['id']]['parent_id']);
            $indexed[$folder['id']]['parent_id'] = end($parts);
        }
    }

    // –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –¥–µ—Ä–µ–≤–æ
    foreach ($indexed as $id => $folder) {
        if ($folder['parent_id'] && isset($indexed[$folder['parent_id']])) {
            $indexed[$folder['parent_id']]['children'][] = &$indexed[$id];
        } else {
            $tree[] = &$indexed[$id];
        }
    }

    return $tree;
}
```

#### –û–±–Ω–æ–≤–∏—Ç—å `update(Request $request, $accountId)`
```php
$request->validate([
    // ... existing validations
    'sync_services' => 'sometimes|boolean',
    'sync_images' => 'sometimes|boolean',
    'create_product_folders' => 'sometimes|boolean',
    'price_mappings' => 'sometimes|array',
    'price_mappings.*.main_price_id' => 'required|uuid',
    'price_mappings.*.child_price_id' => 'required|uuid',
    'attribute_sync_list' => 'sometimes|nullable|array',
    'attribute_sync_list.*' => 'uuid',
]);

$settings = SyncSetting::updateOrCreate(
    ['account_id' => $accountId],
    $request->only([
        // ... existing fields
        'sync_services',
        'sync_images',
        'create_product_folders',
        'price_mappings',
        'attribute_sync_list',
    ])
);
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û

---

### 2.2. –°–æ–∑–¥–∞—Ç—å `app/Http/Controllers/Api/SyncActionsController.php`

```php
<?php

namespace App\Http\Controllers\Api;

use App\Http\Controllers\Controller;
use App\Models\Account;
use App\Models\SyncSetting;
use App\Models\SyncQueue;
use App\Services\MoySkladService;
use App\Services\ProductFilterService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class SyncActionsController extends Controller
{
    /**
     * POST /api/sync/{accountId}/products/all
     *
     * –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—é –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É –∏–∑ main –≤ child
     */
    public function syncAllProducts(Request $request, $accountId)
    {
        $contextData = $request->get('moysklad_context');
        if (!$contextData || !isset($contextData['accountId'])) {
            return response()->json(['error' => 'Account context not found'], 400);
        }

        $mainAccountId = $contextData['accountId'];

        // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —ç—Ç–æ –¥–æ—á–µ—Ä–Ω–∏–π –∞–∫–∫–∞—É–Ω—Ç
        $link = DB::table('child_accounts')
            ->where('parent_account_id', $mainAccountId)
            ->where('child_account_id', $accountId)
            ->first();

        if (!$link) {
            return response()->json(['error' => 'Child account not found'], 404);
        }

        // –ü–æ–ª—É—á–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
        $syncSettings = SyncSetting::where('account_id', $accountId)->first();

        if (!$syncSettings || !$syncSettings->sync_enabled) {
            return response()->json(['error' => 'Sync is not enabled for this account'], 400);
        }

        // –ü–æ–ª—É—á–∏—Ç—å main –∞–∫–∫–∞—É–Ω—Ç
        $mainAccount = Account::where('account_id', $mainAccountId)->first();
        $moysklad = app(MoySkladService::class);
        $filterService = app(ProductFilterService::class);

        $tasksCreated = 0;

        try {
            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–≤–∞—Ä—ã (product)
            if ($syncSettings->sync_products) {
                $products = $this->fetchAllProducts($moysklad, $mainAccount->access_token);
                $tasksCreated += $this->createSyncTasks($products, 'product', $accountId, $syncSettings, $filterService);
            }

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∫–æ–º–ø–ª–µ–∫—Ç—ã (bundle)
            if ($syncSettings->sync_bundles) {
                $bundles = $this->fetchAllBundles($moysklad, $mainAccount->access_token);
                $tasksCreated += $this->createSyncTasks($bundles, 'bundle', $accountId, $syncSettings, $filterService);
            }

            // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —É—Å–ª—É–≥–∏ (service)
            if ($syncSettings->sync_services) {
                $services = $this->fetchAllServices($moysklad, $mainAccount->access_token);
                $tasksCreated += $this->createSyncTasks($services, 'service', $accountId, $syncSettings, $filterService);
            }

            Log::info('Sync all products initiated', [
                'main_account_id' => $mainAccountId,
                'child_account_id' => $accountId,
                'tasks_created' => $tasksCreated
            ]);

            return response()->json([
                'tasks_created' => $tasksCreated,
                'status' => 'queued',
                'message' => "–°–æ–∑–¥–∞–Ω–æ {$tasksCreated} –∑–∞–¥–∞—á —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"
            ]);

        } catch (\Exception $e) {
            Log::error('Failed to sync all products', [
                'main_account_id' => $mainAccountId,
                'child_account_id' => $accountId,
                'error' => $e->getMessage()
            ]);

            return response()->json(['error' => 'Failed to create sync tasks: ' . $e->getMessage()], 500);
        }
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —Ç–æ–≤–∞—Ä—ã
     */
    private function fetchAllProducts(MoySkladService $moysklad, string $token): array
    {
        $allProducts = [];
        $offset = 0;
        $limit = 1000;

        do {
            $response = $moysklad->request($token, 'GET', '/entity/product', [
                'limit' => $limit,
                'offset' => $offset
            ]);

            $products = $response['rows'] ?? [];
            $allProducts = array_merge($allProducts, $products);

            $offset += $limit;
        } while (count($products) === $limit);

        return $allProducts;
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ –∫–æ–º–ø–ª–µ–∫—Ç—ã
     */
    private function fetchAllBundles(MoySkladService $moysklad, string $token): array
    {
        $allBundles = [];
        $offset = 0;
        $limit = 1000;

        do {
            $response = $moysklad->request($token, 'GET', '/entity/bundle', [
                'limit' => $limit,
                'offset' => $offset
            ]);

            $bundles = $response['rows'] ?? [];
            $allBundles = array_merge($allBundles, $bundles);

            $offset += $limit;
        } while (count($bundles) === $limit);

        return $allBundles;
    }

    /**
     * –ü–æ–ª—É—á–∏—Ç—å –≤—Å–µ —É—Å–ª—É–≥–∏
     */
    private function fetchAllServices(MoySkladService $moysklad, string $token): array
    {
        $allServices = [];
        $offset = 0;
        $limit = 1000;

        do {
            $response = $moysklad->request($token, 'GET', '/entity/service', [
                'limit' => $limit,
                'offset' => $offset
            ]);

            $services = $response['rows'] ?? [];
            $allServices = array_merge($allServices, $services);

            $offset += $limit;
        } while (count($services) === $limit);

        return $allServices;
    }

    /**
     * –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –¥–ª—è —Å—É—â–Ω–æ—Å—Ç–µ–π
     */
    private function createSyncTasks(
        array $entities,
        string $entityType,
        string $accountId,
        SyncSetting $syncSettings,
        ProductFilterService $filterService
    ): int {
        $tasksCreated = 0;

        foreach ($entities as $entity) {
            // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
            if ($syncSettings->product_filters_enabled && $syncSettings->product_filters) {
                if (!$filterService->passes($entity, $syncSettings->product_filters)) {
                    continue; // –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å
                }
            }

            // –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É
            SyncQueue::create([
                'account_id' => $accountId,
                'entity_type' => $entityType,
                'entity_id' => $entity['id'],
                'operation' => 'create', // –ò–ª–∏ 'update' –µ—Å–ª–∏ –ø—Ä–æ–≤–µ—Ä—è—Ç—å entity_mappings
                'priority' => 10, // –í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç –¥–ª—è —Ä—É—á–Ω–æ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
                'scheduled_at' => now(),
                'status' => 'pending',
                'attempts' => 0
            ]);

            $tasksCreated++;
        }

        return $tasksCreated;
    }
}
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û

---

### 2.3. –û–±–Ω–æ–≤–∏—Ç—å `routes/api.php`

```php
Route::middleware(['moysklad.context'])->group(function () {
    // ... existing routes

    // Sync settings - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –º–µ—Ç–æ–¥—ã
    Route::get('sync-settings/{accountId}/price-types', [SyncSettingsController::class, 'getPriceTypes']);
    Route::get('sync-settings/{accountId}/attributes', [SyncSettingsController::class, 'getAttributes']);
    Route::get('sync-settings/{accountId}/folders', [SyncSettingsController::class, 'getFolders']);

    // Sync actions
    Route::post('sync/{accountId}/products/all', [SyncActionsController::class, 'syncAllProducts']);
});
```

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–û–¢–û–í–û

---

## –§–∞–∑–∞ 2: –ó–ê–í–ï–†–®–ï–ù–ê ‚úÖ

–°–æ–∑–¥–∞–Ω—ã –≤—Å–µ API –º–µ—Ç–æ–¥—ã –∏ —Ä–æ—É—Ç—ã –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏.

---

## –§–∞–∑–∞ 3: Backend - –°–µ—Ä–≤–∏—Å—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ (1.5 —á–∞—Å–∞) ‚è≥

### 3.1. –û–±–Ω–æ–≤–∏—Ç—å `app/Services/ProductSyncService.php`

**–î–æ–±–∞–≤–∏—Ç—å –ª–æ–≥–∏–∫—É –¥–ª—è —É—á—ë—Ç–∞ –Ω–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫:**

```php
// 1. –£–ø–∞–∫–æ–≤–∫–∏ –∏ —à—Ç—Ä–∏—Ö–∫–æ–¥—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –≤—Å–µ–≥–¥–∞
// –ü—Ä–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ product –≤–∫–ª—é—á–∞—Ç—å:
// - packs[] –º–∞—Å—Å–∏–≤ —É–ø–∞–∫–æ–≤–æ–∫
// - barcodes[] –º–∞—Å—Å–∏–≤ —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤

// 2. –£—á–∏—Ç—ã–≤–∞—Ç—å product_match_field
$matchField = $syncSettings->product_match_field ?? 'article';
// –ò—Å–∫–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π —Ç–æ–≤–∞—Ä –ø–æ —ç—Ç–æ–º—É –ø–æ–ª—é

// 3. –£—á–∏—Ç—ã–≤–∞—Ç—å price_mappings
if ($syncSettings->price_mappings && !empty($syncSettings->price_mappings)) {
    // –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —Ü–µ–Ω—ã —Å –º–∞–ø–ø–∏–Ω–≥–æ–º
}

// 4. –£—á–∏—Ç—ã–≤–∞—Ç—å attribute_sync_list
if ($syncSettings->attribute_sync_list && !empty($syncSettings->attribute_sync_list)) {
    // –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã —Ç–æ–ª—å–∫–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
}

// 5. –£—á–∏—Ç—ã–≤–∞—Ç—å create_product_folders
if (!$syncSettings->create_product_folders) {
    unset($productData['productFolder']);
}
```

### 3.2. –î–æ–±–∞–≤–∏—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —É—Å–ª—É–≥ (services)

**–°–æ–∑–¥–∞—Ç—å –º–µ—Ç–æ–¥ `syncService()` –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ `syncProduct()`:**
- –ó–∞–≥—Ä—É–∂–∞—Ç—å —á–µ—Ä–µ–∑ `/entity/service/{id}`
- –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å: name, description, code, article, price, attributes
- –£—Å–ª—É–≥–∏ –ù–ï –∏–º–µ—é—Ç: variants, bundles, packs

### 3.3. –£–ª—É—á—à–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ –¥–æ–ø.–ø–æ–ª–µ–π

**–°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å `app/Services/AttributeSyncService.php`:**
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ **–Ω–∞–∑–≤–∞–Ω–∏—é –ò —Ç–∏–ø—É**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É `attribute_mappings`

**–°–æ–∑–¥–∞—Ç—å/–æ–±–Ω–æ–≤–∏—Ç—å `app/Services/CharacteristicSyncService.php`:**
- –ü—Ä–æ–≤–µ—Ä—è—Ç—å –ø–æ **–Ω–∞–∑–≤–∞–Ω–∏—é**
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é —Ç–∞–±–ª–∏—Ü—É `characteristic_mappings`

**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ –Ω–∞—á–∞—Ç–æ

---

## –§–∞–∑–∞ 4-6: Frontend (4.5 —á–∞—Å–∞) ‚è≥

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è:
1. `ProductFolderPicker.vue` - –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å –¥–µ—Ä–µ–≤–æ–º –ø–∞–ø–æ–∫
2. `FolderTreeNode.vue` - —Ä–µ–∫—É—Ä—Å–∏–≤–Ω—ã–π —É–∑–µ–ª –¥–µ—Ä–µ–≤–∞
3. `ProductFilterBuilder.vue` - –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤
4. –û–±–Ω–æ–≤–∏—Ç—å `FranchiseSettings.vue` - –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ –Ω–æ–≤—ã–µ —Å–µ–∫—Ü–∏–∏

### API –∫–ª–∏–µ–Ω—Ç:
–û–±–Ω–æ–≤–∏—Ç—å `resources/js/api/index.js`:
```js
syncSettings: {
  getPriceTypes: (accountId) => axios.get(`/api/sync-settings/${accountId}/price-types`),
  getAttributes: (accountId) => axios.get(`/api/sync-settings/${accountId}/attributes`),
  getFolders: (accountId) => axios.get(`/api/sync-settings/${accountId}/folders`),
},
syncActions: {
  syncAllProducts: (accountId) => axios.post(`/api/sync/${accountId}/products/all`),
}
```

**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ –Ω–∞—á–∞—Ç–æ

---

## –§–∞–∑–∞ 7: –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (1 —á–∞—Å) ‚è≥

### –ß–µ–∫-–ª–∏—Å—Ç —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:
- [ ] –ú–∏–≥—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞
- [ ] API —ç–Ω–¥–ø–æ–∏–Ω—Ç—ã —Ä–∞–±–æ—Ç–∞—é—Ç (price-types, attributes, folders)
- [ ] –ö–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ñ–∏–ª—å—Ç—Ä–æ–≤ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ –ø–∞–ø–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ú–∞–ø–ø–∏–Ω–≥ —Ü–µ–Ω —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –∏ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è
- [ ] –í—ã–±–æ—Ä –¥–æ–ø.–ø–æ–ª–µ–π —Ä–∞–±–æ—Ç–∞–µ—Ç
- [ ] –ö–Ω–æ–ø–∫–∞ "–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞—Ç—å –≤—Å—ë" —Å–æ–∑–¥–∞—ë—Ç –∑–∞–¥–∞—á–∏
- [ ] –ó–∞–¥–∞—á–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è ProcessSyncQueueJob
- [ ] –¢–æ–≤–∞—Ä—ã —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è —Å —É–ø–∞–∫–æ–≤–∫–∞–º–∏ –∏ —à—Ç—Ä–∏—Ö–∫–æ–¥–∞–º–∏
- [ ] –§–∏–ª—å—Ç—Ä—ã –ø—Ä–∏–º–µ–Ω—è—é—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

**–°—Ç–∞—Ç—É—Å:** ‚ùå –ù–µ –Ω–∞—á–∞—Ç–æ

---

## –ò—Ç–æ–≥–æ–≤–∞—è –æ—Ü–µ–Ω–∫–∞: ~9 —á–∞—Å–æ–≤

**–ì–æ—Ç–æ–≤–æ –∫ –Ω–∞—á–∞–ª—É —Ä–∞–±–æ—Ç—ã! üöÄ**

–î–∞–≤–∞–π –Ω–∞—á–Ω—ë–º —Å **–§–∞–∑—ã 1: Backend - –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö**?
